name: Auto Assign Reviewers

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  get-changed-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Fetch modified files using GitHub API
        id: fetch_files
        run: |
          echo "Fetching modified files for the PR..."

          # 使用 GitHub API 获取修改的文件列表
          PR_FILES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
          | jq -r '.[].filename' | tr '\n' ',' | sed 's/,$//')  # 格式化文件列表

          # 输出修改的文件
          echo "Modified files: $PR_FILES"
          echo "::set-output name=modified_files::${PR_FILES}"

  generate-comments:
    runs-on: ubuntu-latest
    needs: get-changed-files
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch MAINTAINER.json
        id: fetch_maintainers
        run: |
          echo "Fetching MAINTAINER.json from repository..."
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/MAINTAINER.json
          cat MAINTAINER.json

      - name: Generate comments
        id: generate_comments
        run: |
          echo "Generating comments based on modified files and MAINTAINER.json..."
          python3 tools/ci/auto_comment.py

      - name: Upload comment files
        if: success()
        run: |
          echo "Uploading generated comment files..."
          for file in /tmp/comments/*; do
            echo "Uploading comment: $file"
            COMMENT_BODY=$(cat "$file")
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"$COMMENT_BODY\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          done
