name: PR Review Workflow

on:
  pull_request:
    paths:
      - '**/*'

jobs:
  fetch-modified-files:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install necessary dependencies
      - name: Install jq and GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl
          
      # Step 3: Fetch modified files from the PR
      - name: Fetch modified files
        id: fetch-files
        run: |
          echo "Fetching modified files for the PR..."
          PR_FILES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            | jq -r '.[].filename' | tr '\n' ' ')
          echo "Modified files: $PR_FILES"
          echo "modified_files=$PR_FILES" >> $GITHUB_ENV

  parse-maintenancer-json:
    runs-on: ubuntu-latest
    needs: fetch-modified-files
    steps:
      # Step 4: Parse MAINTAINER.json and determine reviewers for modified files
      - name: Parse MAINTAINER.json and determine reviewers
        id: parse-maintenancer-json
        run: |
          echo "Parsing MAINTAINER.json and determining reviewers..."

          # Initialize variables
          MODIFIED_FILES="${{ env.modified_files }}"
          REVIEWERS_LIST=""
          COMMENT_BODY=""
          
          # Convert the modified files string into an array
          MODIFIED_FILES_ARRAY=($MODIFIED_FILES)

          echo "Initialize variables"

          # Read the MAINTAINER.json file and parse each tag's information
          jq -c '.[]' MAINTAINER.json | while IFS= read -r tag_info; do
            # Extract tag, path, and owner information from the JSON
            tag=$(echo $tag_info | jq -r '.tag')
            path=$(echo $tag_info | jq -r '.path')
            owners=$(echo $tag_info | jq -r '.owner')

            echo "Processing tag: $tag, path: $path, owners: $owners"

            # Check if any modified file matches the path (flexible matching)
            matching_files=()
            for file in "${MODIFIED_FILES_ARRAY[@]}"; do
              # Check if the file path starts with the specified tag's path
              if [[ "$file" == $path/* ]] || [[ "$file" == $path ]]; then
                matching_files+=("$file")
              fi
            done

            if [ ${#matching_files[@]} -gt 0 ]; then
              # Collect reviewers for this tag
              IFS=', ' read -r -a owner_array <<< "$owners"
              reviewers=""
              for owner in "${owner_array[@]}"; do
                reviewer="@$(echo $owner | cut -d'(' -f1)"
                reviewers="$reviewers $reviewer"
              done

              # Prepare the comment for this tag
              TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
              COMMENT_BODY+="\nTimeout: $TIMESTAMP\nReviewer: $reviewers\n\nTag: $tag\nPlease take a review of this tag\n"
            else
              echo "No files match tag $tag"
            fi
          done

          # Debug: Print the comment body for review
          echo "Generated COMMENT_BODY: $COMMENT_BODY"

          # Check if COMMENT_BODY is empty
          if [[ -z "$COMMENT_BODY" ]]; then
            echo "No relevant files modified, skipping comment creation."
            exit 0
          fi

          # Set the reviewers and comment body as output variables
          echo "comment_body=$COMMENT_BODY" >> $GITHUB_ENV
          echo "Reviewers determined: $COMMENT_BODY"

  comment-on-pr:
    runs-on: ubuntu-latest
    needs: parse-maintenancer-json
    steps:
      # Step 5: Comment on PR with the reviewers' list
      - name: Comment on PR with reviewers' list
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMENT_BODY="${{ env.comment_body }}"
          
          # Check if a comment from the bot already exists
          existing_comments=$(gh pr view $PR_NUMBER --json comments -q '.comments[].body')
          comment_exists=$(echo "$existing_comments" | grep -F "$COMMENT_BODY" || true)
          
          if [ -z "$comment_exists" ]; then
            echo "Creating new CI bot comment."
            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          else
            echo "Updating existing CI bot comment."
            # Get the comment ID of the last comment from the bot
            comment_id=$(gh pr view $PR_NUMBER --json comments -q ".comments[?(.body == \"$COMMENT_BODY\")].id")
            gh pr edit $PR_NUMBER --comment-id $comment_id --body "$COMMENT_BODY"
          fi
