name: Auto Reviewers Assignment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files
        run: |
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          echo "$changed_files" | grep -v '^MAINTAINER$' > changed_files.txt
          echo "ğŸ”„ Changed files:"
          cat changed_files.txt | sed 's/^/  - /'

      - name: Parse MAINTAINER file
        id: parse_maintainer
        run: |
          # ä½¿ç”¨ AWK ç²¾å‡†è§£æ MAINTAINER æ–‡ä»¶
          awk '
            /^tag:/ { tag=$2 }
            /^path:/ { path=$2 }
            /^owners:/ {
              # æå–æ‹¬å·å†…çš„ GitHub IDï¼ˆæ’é™¤é‚®ç®±ï¼‰
              split($0, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINER > tag_data.csv
          
          echo "âœ… Parsed data:"
          column -t -s "|" tag_data.csv | sed 's/^/  /'

      - name: Generate review data
        id: generate_review
        run: |
          changed_files=$(cat changed_files.txt)
          rm -f review_data.md
          
          while IFS='|' read -r tag path reviewers; do
            echo "ğŸ” Checking tag [$tag] (path: $path)"
            
            # ä¸¥æ ¼è·¯å¾„åŒ¹é…ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
            matched_files=$(grep -E "^$path(/|$)" changed_files.txt || true)
            if [[ -n "$matched_files" ]]; then
              echo "  âœ… Matched files:"
              echo "$matched_files" | sed 's/^/    - /'
              
              # ç”Ÿæˆæ ¼å¼åŒ–å†…å®¹å—
              {
                echo "### ğŸ·ï¸ Tag: $tag"
                echo "**Path:** \`$path\`  "
                echo "**Reviewers:** $reviewers"
                echo "**Changed Files:**  "
                echo "$matched_files" | sed 's/^/  - /'
                echo ""
              } >> review_data.md
            else
              echo "  âŒ No matching files"
            fi
          done < tag_data.csv
          
          if [[ -f review_data.md ]]; then
            echo "REVIEW_DATA_EXISTS=true" >> $GITHUB_ENV
            echo "ğŸ“ Generated review data:"
            cat review_data.md
          else
            echo "REVIEW_DATA_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Delete old comments
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          echo "::group::Deleting previous comments..."
          comment_ids=$(
            curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" |
            jq -r '.[] | select(.user.login == "github-actions[bot]") | .id'
          )
          
          for id in $comment_ids; do
            echo "Deleting comment $id"
            curl -s -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$id"
          done
          echo "::endgroup::"

      - name: Post structured comment
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          # ç”Ÿæˆä¸“ä¸š Markdown è¯„è®º
          comment_header="## ğŸ“Œ Code Ownership Review Request\n\n"
          comment_body=$(cat review_data.md)
          full_comment="${comment_header}${comment_body}"
          
          # è½¬ä¹‰æ¢è¡Œç¬¦ä¸º JSON å…¼å®¹æ ¼å¼
          formatted_comment=$(echo -e "$full_comment" | sed 's/$/\\n/' | tr -d '\n')
          
          comment_json="{\"body\": \"$formatted_comment\"}"
          
          # å‘é€è¯·æ±‚å¹¶è°ƒè¯•
          response=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$comment_json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          if echo "$response" | grep -q '"message"'; then
            echo "âŒ Error: $(echo "$response" | jq .message)"
            exit 1
          else
            echo "âœ… Comment posted successfully!"
          fi
