name: Code Review Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files
        run: |
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          echo "$changed_files" | grep -v '^MAINTAINER$' > changed_files.txt

      - name: Parse MAINTAINER file
        id: parse_maintainer
        run: |
          awk '
            /^tag:/ { tag=$2 }
            /^path:/ { path=$2 }
            /^owners:/ {
              split($0, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINER > tag_data.csv

      - name: Generate reviewers list
        id: generate_reviewers
        run: |
          rm -f triggered_reviewers.txt
          while IFS='|' read -r tag path reviewers; do
            if grep -qE "^$path(/|$)" changed_files.txt; then
              echo "$reviewers" | tr ' ' '\n' >> triggered_reviewers.txt
            fi
          done < tag_data.csv
          awk 'NF && !seen[$0]++' triggered_reviewers.txt > unique_reviewers.txt

      - name: Get approval status
        id: get_approval
        run: |
          # è·å–æ‰€æœ‰è¯„è®º
          comments=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")

          # æå–æœ‰æ•ˆå®¡æ ¸è®°å½•
          echo 'declare -A approvals' > approval_data.sh
          jq -r '.[] | select(.user.login != "github-actions[bot]") | 
            select(.body | test("\\bLGTM\\b"; "i")) | 
            "approvals[\"@\(.user.login)\"]=\"\(.created_at)\""' <<< "$comments" >> approval_data.sh

          # ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
          {
            echo "### å½“å‰çŠ¶æ€"
            while read -r reviewer; do
              user="${reviewer/@/}"
              if [ -n "${approvals["$reviewer"]}" ]; then
                timestamp=$(date -d "${approvals[$reviewer]}" -u +"%Y-%m-%d %H:%M UTC")
                echo "- âœ… **$reviewer** å®¡æ ¸äº $timestamp"
              else
                echo "- âŒ› **$reviewer** ç­‰å¾…å®¡æ ¸"
              fi
            done < unique_reviewers.txt
          } > review_status.md

      - name: Generate review data
        id: generate_review
        run: |
          current_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          {
            echo "## ğŸ“Œ Code Review Assignment"
            echo ""
            
            # ä»£ç æ‰€æœ‰æƒåŒºå—
            while IFS='|' read -r tag path reviewers; do
              if grep -qE "^$path(/|$)" changed_files.txt; then
                echo "### ğŸ·ï¸ Tag: $tag"
                echo "**Path:** \`$path\`  "
                echo "**Reviewers:** $reviewers  "
                echo "<details>"
                echo "<summary><b>Changed Files</b> (Click to expand)</summary>"
                echo ""
                grep -E "^$path(/|$)" changed_files.txt | sed 's/^/- /'
                echo ""
                echo "</details>"
                echo ""
              fi
            done < tag_data.csv
            
            # å®¡æ ¸çŠ¶æ€åŒºå—
            echo "<details>"
            echo "<summary><b>å®¡æ ¸çŠ¶æ€</b>ï¼ˆæœ€åæ›´æ–°: $current_timeï¼‰</summary>"
            echo ""
            cat review_status.md
            echo ""
            echo "</details>"

            # æ“ä½œæŒ‡å¼•
            echo "### ğŸ“ Review Instructions"
            echo "1. ç»´æŠ¤è€…è¯„è®º \`LGTM\` ç¡®è®¤å®¡æ ¸é€šè¿‡"
            echo "2. [ğŸ”„ åˆ·æ–°çŠ¶æ€](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/rerun)"
          } > review_data.md

      - name: Post/Update comment
        id: post_comment
        run: |
          existing_comment=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" | \
            jq -r '.[] | select(.user.login == "github-actions[bot]") | {id: .id, body: .body} | @base64')
          
          if [[ -n "$existing_comment" ]]; then
            comment_id=$(echo "$existing_comment" | head -1 | base64 -d | jq -r .id)
            echo "Updating existing comment $comment_id"
            response=$(curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$(cat review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id")
          else
            echo "Creating new comment"
            response=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$(cat review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          fi
