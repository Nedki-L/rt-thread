#
# Copyright (c) 2006-2024, RT-Thread Development Team
#
# SPDX-License-Identifier: Apache-2.0
#
# Change Logs:
# Date           Author       Notes
# 2024-08-26     kurisaW      Initial version with reaction-based review tracking
#

name: Auto Reviewers Assignment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files_step
        run: |
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          echo "$changed_files" | grep -v '^MAINTAINER$' > changed_files.txt
          echo "ğŸ”„ Changed files:"
          cat changed_files.txt | sed 's/^/  - /'

      - name: Parse MAINTAINER file
        id: parse_maintainer_step
        run: |
          awk '
            /^tag:/ { tag=$2 }
            /^path:/ { path=$2 }
            /^owners:/ {
              split($0, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINER > tag_data.csv
          echo "âœ… Parsed data:"
          column -t -s "|" tag_data.csv | sed 's/^/  /'

      - name: Generate review data
        id: generate_review_step
        run: |
          changed_files=$(cat changed_files.txt)
          rm -f review_data.md triggered_reviewers.txt

          # ç”Ÿæˆè§¦å‘å®¡æ ¸è€…åˆ—è¡¨
          while IFS='|' read -r tag path reviewers; do
            if grep -qE "^$path(/|$)" changed_files.txt; then
              echo "$reviewers" | tr ' ' '\n' >> triggered_reviewers.txt
            fi
          done < tag_data.csv

          # ç”Ÿæˆå»é‡å®¡æ ¸è€…åˆ—è¡¨ï¼ˆå…³é”®ä¿®å¤ï¼‰
          awk 'NF && !seen[$0]++' triggered_reviewers.txt > unique_reviewers.txt

          # ç”Ÿæˆè¯„è®ºå†…å®¹
          echo "## ğŸ“Œ Code Ownership Review Request" > review_data.md
          echo "" >> review_data.md
          
          while IFS='|' read -r tag path reviewers; do
            if grep -qE "^$path(/|$)" changed_files.txt; then
            {
              echo "## ğŸ“Œ Code Ownership Review Request"
              echo ""
              # æ ‡ç­¾å—...
              echo ""
              echo "### ğŸ“ Review Progress"
              echo "ç»´æŠ¤è€…è¯·é€šè¿‡è¯„è®ºæ ‡è®°å®¡æ ¸å®Œæˆï¼š"
              echo "1. åœ¨ä¸‹æ–¹è¯„è®ºåŒº @github-actions-bot"
              echo "2. å‘é€æŒ‡ä»¤ï¼š\`/review-done @yourname\`"
              echo ""
              echo "<details>"
              echo "<summary><b>å®¡æ ¸çŠ¶æ€</b>ï¼ˆæœ€åæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M UTC')ï¼‰</summary>"
              echo ""
              echo "### å½“å‰çŠ¶æ€"
              while read -r reviewer; do
                echo "- **${reviewer}**: âŒ› ç­‰å¾…å®¡æ ¸"
              done < unique_reviewers.txt
              echo ""
              echo "</details>"
              echo ""
              echo "[ğŸ”„ æ‰‹åŠ¨åˆ·æ–°çŠ¶æ€](https://github.com/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml?query=event:pull_request)"
            } > review_data.md
            fi
          done < tag_data.csv

          # æ·»åŠ å®¡æ ¸è¿›åº¦æ¨¡å—
          echo -e "\n### ğŸ“ Review Progress" >> review_data.md
          echo "ç»´æŠ¤è€…è¯·é€šè¿‡è¯„è®ºæ ‡è®°å®¡æ ¸å®Œæˆï¼š" >> review_data.md
          echo "1. åœ¨ PR è¯„è®ºåŒº @github-actions-bot" >> review_data.md
          echo "2. å‘é€æŒ‡ä»¤ï¼š/review-done @yourname\n" >> review_data.md
          cat unique_reviewers.txt | sed 's/^/- /' >> review_data.md

      - name: Post/Update comment
        id: post_comment
        run: |
          # è·å–æˆ–åˆ›å»ºè¯„è®ºï¼ˆçœç•¥ reactions æƒé™ï¼‰
          comment_body=$(cat review_data.md)
          existing_comment=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" | \
            jq -r '.[] | select(.user.login == "github-actions[bot]") | {id: .id, body: .body}')
          
          if [[ -n "$existing_comment" ]]; then
            comment_id=$(echo "$existing_comment" | jq -r '.id')
            # æ›´æ–°ç°æœ‰è¯„è®º
            response=$(curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$comment_body" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id")
          else
            # åˆ›å»ºæ–°è¯„è®º
            response=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$comment_body" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
            comment_id=$(echo "$response" | jq -r .id)
          fi
          echo "comment_id=$comment_id" >> $GITHUB_ENV

      - name: Track review status
        run: |
          # è·å–æ‰€æœ‰ç›¸å…³è¯„è®º
          comments=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          # æ„å»ºå¸¦æ ¼å¼çš„çŠ¶æ€æŠ¥å‘Š
          status_report=$'\n### å½“å‰å®¡æ ¸çŠ¶æ€ï¼ˆè‡ªåŠ¨æ›´æ–°äº '
          status_report+=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          status_report+=$'ï¼‰\n\n'

          while read -r reviewer; do
            if echo "$comments" | grep -q "/review-done ${reviewer}"; then
              status_report+=$'âœ… **'"${reviewer}** å·²å®¡æ ¸\n"
            else
              status_report+=$'âŒ› **'"${reviewer}** ç­‰å¾…å®¡æ ¸\n"
            fi
          done < unique_reviewers.txt

          # æ›´æ–°è¯„è®ºå†…å®¹
          current_body=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}" | jq -r .body)
          
          updated_body="${current_body%%### å½“å‰å®¡æ ¸çŠ¶æ€*}"
          updated_body+="$status_report"
          
          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d "$(jq -n --arg body "$updated_body" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}"

      - name: Setup reaction trackers
        run: |
          # ä¸ºæ¯ä¸ªå®¡æ ¸è€…æ·»åŠ é”šç‚¹ååº”
          while read -r reviewer; do
            # æ·»åŠ å”¯ä¸€æ ‡è¯†ååº”
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.squirrel-girl-preview+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}/reactions" \
              -d '{"content":"eyes"}'  # ğŸ‘€ ä½œä¸ºè¿½è¸ªé”šç‚¹
          done < unique_reviewers.txt

      - name: Process comment commands
        if: github.event_name == 'issue_comment'
        run: |
          # ä»…å¤„ç†åŒ…å«æŒ‡ä»¤çš„è¯„è®º
          comment_body="${{ github.event.comment.body }}"
          case "$comment_body" in
            */review-done*)
              echo "å¤„ç†å®¡æ ¸å®ŒæˆæŒ‡ä»¤..."
              reviewer=$(echo "$comment_body" | sed -nE 's/.*\/review-done +@([a-zA-Z0-9_-]+).*/\1/p')
              # è®°å½•å®¡æ ¸æ—¶é—´
              date -u +"%Y-%m-%d %H:%M UTC" >> "review_status.txt"
              echo "$reviewer" >> "review_status.txt"
              ;;
            */refresh*)
              echo "æ‰‹åŠ¨è§¦å‘çŠ¶æ€åˆ·æ–°..."
              ;;
          esac

      - name: Update review status
        run: |
          # åŠ è½½å®¡æ ¸è®°å½•
          declare -A reviewed
          if [[ -f "review_status.txt" ]]; then
            while read -r line; do
              if [[ "$line" =~ ^[0-9]{4}- ]]; then
                current_date="$line"
              else
                reviewed["$line"]="$current_date"
              fi
            done < review_status.txt
          fi

          # ç”ŸæˆåŠ¨æ€çŠ¶æ€æŠ¥å‘Š
          status_report=$'### å½“å‰çŠ¶æ€\n'
          while read -r reviewer; do
            user_name="${reviewer//@/}"
            if [[ -n "${reviewed[$user_name]}" ]]; then
              status_report+=$'- âœ… **'"${reviewer}** å®¡æ ¸äº ${reviewed[$user_name]}\n"
            else
              status_report+=$'- âŒ› **'"${reviewer}** ç­‰å¾…å®¡æ ¸\n"
            fi
          done < unique_reviewers.txt

          # æ›´æ–°è¯„è®ºå†…å®¹
          current_body=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}" | jq -r .body)
          
          # ä½¿ç”¨awkä¿æŒåŸæœ‰ç»“æ„
          updated_body=$(echo "$current_body" | awk -v new_status="$status_report" '
            /<summary><b>å®¡æ ¸çŠ¶æ€/,/<\/details>/ {
              if ($0 ~ /<details>/) print
              if ($0 ~ /<summary>/) print
              if ($0 ~ /### å½“å‰çŠ¶æ€/) {
                print new_status
                while (getline > 0 && !/<\/details>/) {}
              }
              next
            }
            { print }
          ')

          # æäº¤æ›´æ–°
          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d "$(jq -n --arg body "$updated_body" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}"
