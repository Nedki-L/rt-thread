name: PR Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-comment:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.11'

    # Step 3: Install dependencies (if you have any)
    - name: Install dependencies
      run: |
        pip install -r requirements.txt  # 如果你有依赖的话（如requests等）

    # Step 4: Run the Python script to generate the comment
    - name: Generate comment
      run: |
        python tools/ci/auto_comment.py  # 调用生成评论的 Python 脚本

    # Step 5: Upload the comment file as artifact
    - name: Upload comment file
      uses: actions/upload-artifact@v3
      with:
        name: comment-file
        path: /tmp/comment_body.txt

  post-comment:
    runs-on: ubuntu-latest
    needs: generate-comment
    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Download the comment file from previous job
    - name: Download comment file
      uses: actions/download-artifact@v3
      with:
        name: comment-file

    # Step 3: Post the comment to GitHub
    - name: Post comment to GitHub PR
      run: |
        COMMENT_BODY=$(cat comment-file/comment_body.txt)
        curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
             -d '{"body": "'"${COMMENT_BODY}"'"}' \
             "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
