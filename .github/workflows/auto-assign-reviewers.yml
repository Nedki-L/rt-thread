name: Auto Assign Reviewers

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  get-changed-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Fetch modified files
        id: fetch_files
        run: |
          echo "Fetching modified files for the PR..."

          # Fetch the PR and the base branch (master)
          git fetch origin master
          git fetch origin pull/${{ github.event.pull_request.number }}/merge

          # Get the first commit of the PR (if it's the first commit, it will be the same as the merge commit)
          first_commit_sha=$(git log --reverse --format=%H -n 1 origin/master..HEAD)

          # Get the modified files for the PR (the changes from the first commit to the latest commit)
          modified_files=$(git diff --name-only $first_commit_sha^..$first_commit_sha)

          # Output the modified files
          echo "Modified files: $modified_files"
          echo "::set-output name=modified_files::${modified_files}"

  generate-comments:
    runs-on: ubuntu-latest
    needs: get-changed-files
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch MAINTAINER.json
        id: fetch_maintainers
        run: |
          echo "Fetching MAINTAINER.json from repository..."
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/MAINTAINER.json
          cat MAINTAINER.json

      - name: Generate comments
        id: generate_comments
        run: |
          echo "Generating comments based on modified files and MAINTAINER.json..."
          python3 tools/ci/auto_comment.py

      - name: Upload comment files
        if: success()
        run: |
          echo "Uploading generated comment files..."
          for file in /tmp/comments/*; do
            echo "Uploading comment: $file"
            COMMENT_BODY=$(cat "$file")
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"$COMMENT_BODY\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          done
