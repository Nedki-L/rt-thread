name: Auto Review Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  assign-reviewers:
    concurrency:
      group: assign-reviewers-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-22.04
    if: github.repository_owner == 'Nedki-L'
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files
        run: |
          page=1
          echo "" > changed_files.txt
          while true; do
            response=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files?page=$page&per_page=100")
            
            files=$(echo "$response" | jq -r '.[].filename')
            if [ -z "$files" ]; then
              break
            fi
            echo "$files" | grep -v '^MAINTAINERS$' >> changed_files.txt
            page=$((page+1))
          done

      - name: Parse MAINTAINERS file
        id: parse_maintainer
        run: |
          awk '
            BEGIN { FS="[ \t]*:[ \t]*" }
            /^tag:/ { tag=$2 }
            /^path:/ { path=$2 }
            /^owners:/ {
              split($0, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINERS > tag_data.csv

      - name: Generate reviewers list
        id: generate_reviewers
        run: |
          rm -f triggered_reviewers.txt
          while IFS='|' read -r tag path reviewers; do
            if grep -qE "^$path(/|$)" changed_files.txt; then
              echo "$reviewers" | tr ' ' '\n' >> triggered_reviewers.txt
            fi
          done < tag_data.csv
          awk 'NF && !seen[$0]++' triggered_reviewers.txt > unique_reviewers.txt

      - name: Build mention registry
        id: mention_registry
        run: |
          # Ëé∑ÂèñPRÊâÄÊúâÂéÜÂè≤ËØÑËÆ∫‰∏≠ÁöÑ@ËÆ∞ÂΩï
          page=1
          echo "" > all_mentions.txt
          while true; do
            response=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments?page=$page&per_page=100")
            
            mentions=$(echo "$response" | jq -r '.[] | select(.user.login == "github-actions[bot]") | .body' | \
              grep -oE '@[a-zA-Z0-9_-]+' | tr '[:upper:]' '[:lower:]')
            
            if [ -z "$mentions" ]; then
              break
            fi
            echo "$mentions" >> all_mentions.txt
            page=$((page+1))
          done
          
          # ÁîüÊàêÊ†áÂáÜÂåñÂîØ‰∏ÄËÆ∞ÂΩï
          awk '!seen[tolower($0)]++' all_mentions.txt > mentioned_users.txt
          echo "Existing mentions:"
          cat mentioned_users.txt

      - name: Generate review data
        id: generate_review
        run: |
          declare -A new_mentions=()
          
          {
            echo "## üìå Code Review Assignment"
            echo ""
            
            while IFS='|' read -r tag path reviewers; do
              if grep -qE "^$path(/|$)" changed_files.txt; then
                echo "### üè∑Ô∏è Tag: $tag"
                echo "**Path:** \`$path\`  "
                echo -n "**Reviewers:** "
                
                # Â§ÑÁêÜÊØè‰∏™ÂÆ°Ê†∏ËÄÖ
                processed=()
                for reviewer in $reviewers; do
                  normalized=$(echo "$reviewer" | tr '[:upper:]' '[:lower:]')
                  if grep -qi "^$normalized$" mentioned_users.txt || [[ -n "${new_mentions[$normalized]}" ]]; then
                    processed+=("${reviewer#@}")
                  else
                    processed+=("$reviewer")
                    new_mentions[$normalized]=1
                  fi
                done
                
                # Ê†ºÂºèÂåñËæìÂá∫
                echo "$(IFS=', '; echo "${processed[*]}")  "
                
                # ÊòæÁ§∫ÂèòÊõ¥Êñá‰ª∂
                echo "<details>"
                echo "<summary><b>Changed Files</b> (Click to expand)</summary>"
                echo ""
                grep -E "^$path(/|$)" changed_files.txt | sed 's/^/- /'
                echo ""
                echo "</details>"
                echo ""
              fi
            done < tag_data.csv

            cat review_status.md
            
            echo "---"
            echo "### üìù Review Instructions"
            echo ""
            echo "1. [üîÑ Âà∑Êñ∞Áä∂ÊÄÅ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/rerun)"
            echo "2. Comment \`LGTM\` after approval"
            echo "3. Requires at least one maintainer approval"
          } > review_data.md
          
          # Êõ¥Êñ∞mentionËÆ∞ÂΩï
          for mention in "${!new_mentions[@]}"; do
            echo "$mention" >> mentioned_users.txt
          done
          awk '!seen[$0]++' mentioned_users.txt > tmp && mv tmp mentioned_users.txt

      - name: Post/Update comment
        id: post_comment
        run: |
          # ÂØπÊØîÂπ∂Êõ¥Êñ∞ËØÑËÆ∫
          current_body=$(cat review_data.md)
          existing_comments=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          comment_id=$(echo "$existing_comments" | jq -r '.[] | select(.user.login == "github-actions[bot]") | .id' | head -1)
          
          if [ -n "$comment_id" ]; then
            existing_body=$(echo "$existing_comments" | jq -r ".[] | select(.id == $comment_id) | .body")
            if [ "$existing_body" != "$current_body" ]; then
              curl -s -X PATCH \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -d "$(jq -n --arg body "$current_body" '{body: $body}')" \
                "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id"
            fi
          else
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$current_body" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          fi
