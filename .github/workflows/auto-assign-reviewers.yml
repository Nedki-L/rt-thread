name: Auto Reviewers Assignment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files
        run: |
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          filtered_files=$(echo "$changed_files" | grep -v '^MAINTAINER$')
          echo "$filtered_files" > changed_files.txt
          echo "ğŸ”„ Changed files detected:"
          cat changed_files.txt | sed 's/^/  - /'

      - name: Parse MAINTAINER file
        id: parse_maintainer
        run: |
          echo "ğŸ“– Parsing MAINTAINER file..."
          maintainer_content=$(cat MAINTAINER)
          echo -e "tag|path|reviewers\n$(echo "$maintainer_content" | sed -n '/^tag:/{N;N;p}' | sed 'N;s/\n/|/g')" > tag_data.csv
          echo "âœ… Parsed CSV data:"
          column -t -s "|" tag_data.csv | sed 's/^/  /'

      - name: Match tags and generate review list
        id: match_tags
        run: |
          changed_files=$(cat changed_files.txt)
          
          # ç”ŸæˆæŒ‰æ ‡ç­¾åˆ†ç»„çš„å®¡é˜…è€…æ•°æ®
          rm -f review_data.md
          while IFS='|' read -r tag path owners; do
            [[ "$tag" == "tag" ]] && continue  # è·³è¿‡æ ‡é¢˜è¡Œ
            
            # æå– GitHub IDï¼ˆç²¾ç¡®åŒ¹é…æ‹¬å·å†…å®¹ï¼‰
            github_ids=$(echo "$owners" | sed -E 's/[^,(]*\(([^)]+)\)[^,]*/@\1/g' | tr ',' ' ' | xargs | tr ' ' '\n' | sort -u | tr '\n' ' ')
            
            # æ£€æŸ¥æ–‡ä»¶è·¯å¾„åŒ¹é…
            matched_files=$(grep -E "^$path(/|$)" changed_files.txt || true)
            if [[ -n "$matched_files" ]]; then
              echo "ğŸ“Œ **Tag: $tag**" >> review_data.md
              echo "ğŸ“ **Path**: \`$path\`" >> review_data.md
              echo "ğŸ‘¥ **Reviewers**: $github_ids" >> review_data.md
              echo "ğŸ“ **Changed Files**:" >> review_data.md
              echo "$matched_files" | sed 's/^/  - /' >> review_data.md
              echo "" >> review_data.md
            fi
          done < tag_data.csv
          
          # ä¿å­˜ç»“æœ
          if [[ -f review_data.md ]]; then
            echo "REVIEW_DATA_EXISTS=true" >> $GITHUB_ENV
            echo "âœ… Generated review data:"
            cat review_data.md
          else
            echo "REVIEW_DATA_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Delete old comments
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          echo "ğŸ§¹ Cleaning up previous comments..."
          comments=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          echo "$comments" | jq -r '.[] | select(.user.login == "github-actions[bot]") | .id' | while read -r comment_id; do
            echo "  ğŸ—‘ Deleting comment $comment_id"
            curl -s -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id"
          done

      - name: Post structured comment
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          echo "ğŸ“ Generating professional review comment..."
          comment_header="## ğŸ“Œ Code Owners Request\n\n**Detected modifications require review from the following experts:**\n\n"
          comment_body=$(cat review_data.md | sed 's/ğŸ“Œ/###/g; s/ğŸ“/**Path**:/g; s/ğŸ‘¥/**Reviewers**:/g; s/ğŸ“/**Changed Files**:/g')
          
          full_comment="${comment_header}${comment_body}"
          echo -e "âœ‰ï¸ Final comment content:\n${full_comment}" | sed 's/^/  /'
          
          # ä½¿ç”¨ JSON å®‰å…¨æ ¼å¼åŒ–
          comment_json=$(jq -n --arg body "$full_comment" '{body: $body}' | sed 's/\\n/\n/g')
          
          response=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$comment_json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          if echo "$response" | grep -q '"message"'; then
            echo "âŒ Failed to post comment:"
            echo "$response" | jq .
            exit 1
          else
            echo "âœ… Comment posted successfully!"
          fi
