name: Auto Reviewers Assignment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files_step
        run: |
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          echo "$changed_files" | grep -v '^MAINTAINER$' > changed_files.txt
          echo "ğŸ”„ Changed files:"
          cat changed_files.txt | sed 's/^/  - /'

      - name: Parse MAINTAINER file
        id: parse_maintainer_step
        run: |
          awk '
            /^tag:/ { tag=$2 }
            /^path:/ { path=$2 }
            /^owners:/ {
              split($0, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINER > tag_data.csv
          echo "âœ… Parsed data:"
          column -t -s "|" tag_data.csv | sed 's/^/  /'

      - name: Generate review data
        id: generate_review_step
        run: |
          changed_files=$(cat changed_files.txt)
          rm -f review_data.md triggered_reviewers.txt
          
          # åˆå§‹åŒ–è¯„è®ºå†…å®¹
          echo "## ğŸ“Œ Code Ownership Review Request" > review_data.md
          echo "" >> review_data.md
          
          # ç”Ÿæˆæ ‡ç­¾å—å¹¶è®°å½•å®é™…è§¦å‘å®¡æ ¸è€…
          while IFS='|' read -r tag path reviewers; do
            matched_files=$(grep -E "^$path(/|$)" changed_files.txt || true)
            if [[ -n "$matched_files" ]]; then
              # å†™å…¥æ ‡ç­¾å—
              {
                echo "### ğŸ·ï¸ Tag: $tag"
                echo "**Path:** \`$path\`  "
                echo "**Reviewers:** $reviewers  "
                echo "<details>"
                echo "<summary><b>Changed Files</b> (Click to expand)</summary>"
                echo ""
                echo "$matched_files" | sed 's/^/- /'
                echo ""
                echo "</details>"
                echo ""
              } >> review_data.md
              
              # è®°å½•å½“å‰æ ‡ç­¾çš„å®¡æ ¸è€…ï¼ˆå…³é”®ä¿®å¤ï¼‰
              echo "$reviewers" | tr ' ' '\n' >> triggered_reviewers.txt
            fi
          done < tag_data.csv
      
          # åŠ¨æ€ç”Ÿæˆå®¡æ ¸è€…åˆ—è¡¨ï¼ˆä»…åŒ…å«å®é™…è§¦å‘äººå‘˜ï¼‰
          if [[ -f triggered_reviewers.txt ]]; then
            awk '!seen[$0]++' triggered_reviewers.txt > unique_reviewers.txt  # å»é‡å¹¶ä¿ç•™é¡ºåº
            
            # æ·»åŠ å®¡æ ¸è¿›åº¦æ¨¡å—
            if [[ -s unique_reviewers.txt ]]; then
              {
                echo "---"
                echo "### ğŸ“ Review Progress"
                echo "Click checkboxes to mark completion:"
                while read -r reviewer; do
                  [[ -n "$reviewer" ]] && echo "- [ ] $reviewer"
                done < unique_reviewers.txt
                echo ""
                echo "*Note: Checkboxes are interactive in GitHub comments.*"
              } >> review_data.md
            fi
          fi
      
          # è®¾ç½®ç¯å¢ƒå˜é‡
          if [[ -s review_data.md ]]; then
            echo "REVIEW_DATA_EXISTS=true" >> $GITHUB_ENV
            echo "ğŸ“ Generated review data:"
            cat review_data.md
          else
            echo "REVIEW_DATA_EXISTS=false" >> $GITHUB_ENV
          fi
          # è®¾ç½®ç¯å¢ƒå˜é‡
          if [[ -s review_data.md ]]; then
            echo "REVIEW_DATA_EXISTS=true" >> $GITHUB_ENV
            echo "ğŸ“ Generated review data:"
            cat review_data.md
          else
            echo "REVIEW_DATA_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Delete old comments
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          echo "::group::Cleaning up previous comments..."
          
          # è·å–æ‰€æœ‰è¯„è®ºï¼ˆå¤„ç†åˆ†é¡µï¼‰
          page=1
          all_comments=""
          while true; do
            comments=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments?per_page=100&page=$page")
            
            # åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ•°æ®
            if [[ $(echo "$comments" | jq '. | length') -eq 0 ]]; then
              break
            fi
            
            all_comments+=$(echo "$comments" | jq -c '.[]')
            ((page++))
          done

          # æå–éœ€è¦åˆ é™¤çš„è¯„è®ºID
          comment_ids=$(echo "$all_comments" | jq -r 'select(.user.login == "github-actions[bot]") | .id')
          
          echo "Found ${#comment_ids[@]} bot comments to delete"
          
          # åˆ é™¤æ‰€æœ‰å†å²è¯„è®º
          for id in $comment_ids; do
            echo "Deleting comment $id"
            curl -s -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$id"
          done
          echo "::endgroup::"

      - name: Post structured comment
        if: env.REVIEW_DATA_EXISTS == 'true'
        run: |
          full_comment=$(cat review_data.md)
          
          # å®‰å…¨ç”ŸæˆJSONï¼ˆè‡ªåŠ¨å¤„ç†æ¢è¡Œç¬¦ï¼‰
          comment_json=$(jq -n --arg body "$full_comment" '{body: $body}')
          
          # å‘é€è¯·æ±‚
          response=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$comment_json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          
          echo "âœ… Comment posted at: $(echo "$response" | jq .html_url)"
