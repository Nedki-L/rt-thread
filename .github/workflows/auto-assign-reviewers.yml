name: PR Review Commenter

on:
  pull_request:
    types: [opened, synchronize, reopened]  # 当PR打开、更新或重新打开时触发

jobs:
  review-comment:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install necessary dependencies
      - name: Install jq and GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # Step 3: Fetch modified files from the PR
      - name: Fetch modified files for the PR
        id: fetch-pr-files
        run: |
          echo "Fetching modified files for the PR..."
          PR_FILES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            | jq -r '.[].filename' | tr '\n' ' ')

          echo "Modified files: $PR_FILES"
          echo "modified_files=$PR_FILES" >> $GITHUB_ENV

      # Step 4: Parse MAINTAINER.json and check file tags
      - name: Parse MAINTAINER.json and determine reviewers
        id: parse-maintenancer-json
        run: |
          echo "Parsing MAINTAINER.json and determining reviewers..."

          # Loop through each modified file and determine the tags and reviewers
          MODIFIED_FILES="${{ env.modified_files }}"

          # Parse MAINTAINER.json and loop through each entry
          while IFS= read -r tag_info; do
            tag=$(echo $tag_info | jq -r '.tag')
            path=$(echo $tag_info | jq -r '.path')
            owners=$(echo $tag_info | jq -r '.owner')

            # Check if any modified file matches the path
            for file in $MODIFIED_FILES; do
              if [[ "$file" == $path* ]]; then
                echo "File $file matches tag $tag"
                
                # Collect reviewers for this tag
                IFS=', ' read -r -a owner_array <<< "$owners"
                for owner in "${owner_array[@]}"; do
                  reviewer_list="$reviewer_list @$(echo $owner | cut -d'(' -f1) "
                done
              fi
            done
          done < <(jq -c '.[]' MAINTAINER.json)  # Read each element from MAINTAINER.json

          # Set the reviewers as an output variable
          echo "reviewers=$reviewer_list" >> $GITHUB_ENV
          echo "Reviewers determined: $reviewer_list"

      # Step 5: Create or update CI review comment
      - name: Create or update CI comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use the GITHUB_TOKEN as the environment variable for gh
        run: |
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
          COMMENT_BODY="Timestamp: $TIMESTAMP\n\nReviewer: ${{ env.reviewers }}\n\n"
          
          # Fetch existing comments and update if necessary
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMENTS=$(gh pr view $PR_NUMBER --json comments -q ".comments")
          
          # Check if there's an existing CI bot comment
          EXISTING_COMMENT=$(echo "$COMMENTS" | jq -r '.[] | select(.user.login=="github-actions[bot]") | .id' || true)

          if [[ -n "$EXISTING_COMMENT" ]]; then
            echo "Updating existing comment."
            gh pr comment $PR_NUMBER --body "$COMMENT_BODY" --comment-id $EXISTING_COMMENT
          else
            echo "Creating new comment."
            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          fi
