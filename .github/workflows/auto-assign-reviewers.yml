#
# Copyright (c) 2006-2024, RT-Thread Development Team
#
# SPDX-License-Identifier: Apache-2.0
#
# Change Logs:
# Date           Author       Notes
# 2024-08-26     kurisaW      Initial version with reaction-based review tracking
#

name: Auto Reviewers Assignment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°çŠ¶æ€

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      reactions: write
    steps:
      # ... [ä¿ç•™åŸæœ‰ checkoutã€è·å–æ–‡ä»¶ã€è§£æMAINTAINERç­‰æ­¥éª¤] ...

      - name: Generate review data
        id: generate_review_step
        run: |
          # ... [ä¿ç•™åŸæœ‰ç”Ÿæˆreview_data.mdé€»è¾‘] ...

          # ç”Ÿæˆå®¡æ ¸è¿›åº¦æ¨¡æ¿
          echo -e "\n\n### ğŸ“ Review Progress Tracking" >> review_data.md
          echo "è¯·å®¡æ ¸è€…åœ¨æ‚¨çš„ç”¨æˆ·åæ—æ·»åŠ  âœ… è¡¨æƒ…æ ‡è®°å®¡æ ¸å®Œæˆï¼š" >> review_data.md
          echo "1. æ‰¾åˆ°æ‚¨çš„ç”¨æˆ·å" >> review_data.md
          echo "2. ç‚¹å‡»è¯„è®ºå³ä¸Šè§’è¡¨æƒ…æŒ‰é’®" >> review_data.md
          echo "3. é€‰æ‹© âœ… è¡¨æƒ…å¹¶æäº¤\n" >> review_data.md

          # ç”Ÿæˆå¯è¿½è¸ªçš„å®¡æ ¸è€…åˆ—è¡¨
          awk '!seen[$0]++' triggered_reviewers.txt | while read -r reviewer; do
            echo "- **${reviewer}**  [æŸ¥çœ‹çŠ¶æ€](#status-${reviewer//@/})" >> review_data.md
          done

      - name: Post/Update comment
        id: post_comment
        run: |
          # æŸ¥æ‰¾å·²æœ‰çš„Actionè¯„è®º
          existing_comment=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" | \
            jq -r '.[] | select(.user.login == "github-actions[bot]") | {id: .id, body: .body} | @base64')

          # åˆå¹¶æ–°æ—§å†…å®¹ï¼ˆä¿ç•™çŠ¶æ€ï¼‰
          new_comment_body=$(cat review_data.md)
          if [[ -n "$existing_comment" ]]; then
            # æå–å†å²çŠ¶æ€
            old_body=$(echo "$existing_comment" | head -1 | base64 -d | jq -r .body)
            merged_body="${new_comment_body%%### ğŸ“ Review Progress Tracking*}"
            merged_body+=$(echo "$old_body" | awk '/### ğŸ“ Review Progress Tracking/{flag=1} flag')
            echo "$merged_body" > review_data.md
            comment_id=$(echo "$existing_comment" | head -1 | base64 -d | jq -r .id)
            
            # æ›´æ–°ç°æœ‰è¯„è®º
            response=$(curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$merged_body" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id")
          else
            # åˆ›å»ºæ–°è¯„è®º
            response=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$new_comment_body" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
            comment_id=$(echo "$response" | jq -r .id)
          fi

          # è®¾ç½®è¯„è®ºIDè¾“å‡º
          echo "comment_id=$comment_id" >> $GITHUB_ENV

      - name: Setup reaction trackers
        run: |
          # ä¸ºæ¯ä¸ªå®¡æ ¸è€…æ·»åŠ é”šç‚¹ååº”
          while read -r reviewer; do
            # æ·»åŠ å”¯ä¸€æ ‡è¯†ååº”
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.squirrel-girl-preview+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}/reactions" \
              -d '{"content":"eyes"}'  # ğŸ‘€ ä½œä¸ºè¿½è¸ªé”šç‚¹
          done < unique_reviewers.txt

      - name: Update review status
        run: |
          # è·å–æ‰€æœ‰ååº”æ•°æ®
          reactions=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.squirrel-girl-preview+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}/reactions")

          # ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
          status_report=$'\n### å½“å‰å®¡æ ¸çŠ¶æ€ï¼ˆè‡ªåŠ¨æ›´æ–°äº '
          status_report+=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          status_report+=$'ï¼‰\n'

          while read -r reviewer; do
            # æå–æœ‰æ•ˆå®¡æ ¸ååº”
            check_mark=$(echo "$reactions" | jq -r \
              ".[] | select(.user.login == \"${reviewer//@/}\" and .content == \"+1\") | .created_at")

            if [[ -n "$check_mark" ]]; then
              status_report+="âœ… **${reviewer}** å·²å®¡æ ¸ï¼ˆ$(date -d "$check_mark" -u +'%m-%d %H:%M') UTCï¼‰\n"
            else
              status_report+="âŒ› **${reviewer}** ç­‰å¾…å®¡æ ¸\n"
            fi
          done < unique_reviewers.txt

          # æ›´æ–°è¯„è®ºçŠ¶æ€
          current_body=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}" | jq -r .body)

          updated_body="${current_body%%### å½“å‰å®¡æ ¸çŠ¶æ€*}"
          updated_body+="$status_report"

          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d "$(jq -n --arg body "$updated_body" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ env.comment_id }}"
